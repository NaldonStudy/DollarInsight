# Docker 내장 DNS resolver 설정 (동적 DNS 해석)
# valid=10s: DNS 캐시를 10초만 유지
# ipv6=off: IPv6 비활성화
resolver 127.0.0.11 valid=10s ipv6=off;

server {
    listen 80;
    server_name _;

    # 클라이언트 요청 사이즈 제한
    client_max_body_size 100M;

    # Gzip 압축 설정
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Health check (Nginx 자체)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Backend API 프록시
    location /api/ {
        # 변수 사용으로 매 요청마다 DNS 재해석 (IP 변경 시 자동 대응)
        set $backend_upstream dollar-insight-backend:9090;
        proxy_pass http://$backend_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeout 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Backend Actuator (헬스체크, 모니터링)
    location /actuator/ {
        # 변수 사용으로 매 요청마다 DNS 재해석
        set $backend_upstream dollar-insight-backend:9090;
        proxy_pass http://$backend_upstream/actuator/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # AI Service API 프록시
    location /ai/ {
        # 변수 사용으로 매 요청마다 DNS 재해석
        set $ai_upstream dollar-insight-ai-service:8000;
        proxy_pass http://$ai_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeout 설정 (AI 처리 시간이 길 수 있음)
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ============================================
    # Admin Tools (관리 도구)
    # ============================================

    # pgAdmin (PostgreSQL 관리 도구)
    location /pgadmin/ {
        proxy_pass http://pgadmin:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Script-Name /pgadmin;
        
        # WebSocket 지원
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_redirect off;
        proxy_buffering off;
    }

    # Mongo Express (MongoDB 관리 도구)
    location /mongo-express/ {
        proxy_pass http://mongo-express:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_redirect off;
    }

    # Redis Commander (Redis 관리 도구)
    location /redis-commander/ {
        proxy_pass http://redis-commander:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 지원 (Redis Commander도 필요)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_redirect off;
    }

    # 기본 루트
    location / {
        return 200 "Dollar InSight API Gateway\n";
        add_header Content-Type text/plain;
    }
}