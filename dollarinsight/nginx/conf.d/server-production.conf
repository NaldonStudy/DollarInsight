# ============================================
# HTTP â†’ HTTPS ë¦¬ë‹¤ì´ë ‰ì…˜
# ============================================
server {
    listen 80;
    server_name k13b205.p.ssafy.io;

    # Let's Encrypt ì¸ì¦ì„œ ê°±ì‹ ì„ ìœ„í•œ ê²½ë¡œ
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # ë‚˜ë¨¸ì§€ ëª¨ë“  ìš”ì²­ì€ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ============================================
# HTTPS ì„œë²„ (PRODUCTION - ë³´ì•ˆ ê°•í™”)
# ============================================
server {
    listen 443 ssl;
    http2 on;
    server_name k13b205.p.ssafy.io;

    # SSL ì¸ì¦ì„œ
    ssl_certificate /etc/letsencrypt/live/k13b205.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/k13b205.p.ssafy.io/privkey.pem;

    # ë³´ì•ˆ ì„¤ì • include
    include /etc/nginx/conf.d/security.conf;

    # í—¤ë” ì´ë¦„ì— ì–¸ë”ìŠ¤ì½”ì–´ í—ˆìš© (X-Device-Id ê°™ì€ ì»¤ìŠ¤í…€ í—¤ë” ì²˜ë¦¬)
    underscores_in_headers on;

    # í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì‚¬ì´ì¦ˆ ì œí•œ
    client_max_body_size 100M;

    # Gzip ì••ì¶• ì„¤ì •
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Rate limiting ì ìš©
    limit_req zone=general burst=20 nodelay;
    limit_conn addr 10;

    # ============================================
    # ğŸ”“ PUBLIC - APK ë‹¤ìš´ë¡œë“œ (ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©)
    # ============================================

    # ë‹¤ìš´ë¡œë“œ í˜ì´ì§€
    location /download {
        alias /usr/share/nginx/html/download;
        index index.html;
        try_files $uri $uri/ /download/index.html;

        # ë³´ì•ˆ í—¤ë”
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
    }

    # APK íŒŒì¼ ì§ì ‘ ë‹¤ìš´ë¡œë“œ
    location /apk {
        alias /usr/share/nginx/html/apk;
        autoindex off;

        # APK íŒŒì¼ MIME íƒ€ì… ì„¤ì •
        types {
            application/vnd.android.package-archive apk;
        }

        # ë³´ì•ˆ í—¤ë”
        add_header X-Content-Type-Options "nosniff" always;
        add_header Content-Disposition "attachment" always;

        # ë‹¤ìš´ë¡œë“œ ì†ë„ ì œí•œ (ì„ íƒì‚¬í•­ - í•„ìš”ì‹œ í™œì„±í™”)
        # limit_rate 1m;
    }

    # ============================================
    # ğŸ”“ PUBLIC - Health check (Nginx ìì²´)
    # ============================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ============================================
    # ğŸ”’ PROTECTED - Swagger UI & API Docs (ê°œë°œíŒ€ë§Œ ì ‘ê·¼)
    # ============================================

    # ğŸš« PRODUCTION: Swagger UI ì™„ì „ ì°¨ë‹¨
    location /swagger-ui/ {
        deny all;
        return 403 "Access Forbidden - Swagger UI is disabled in production";
        add_header Content-Type text/plain;
    }

    # ğŸš« PRODUCTION: API Docs ì™„ì „ ì°¨ë‹¨
    location /v3/api-docs {
        deny all;
        return 403 "Access Forbidden - API Docs are disabled in production";
        add_header Content-Type text/plain;
    }

    # ğŸ’¡ ê°œë°œ í™˜ê²½ì—ì„œë§Œ Swagger ì ‘ê·¼ì´ í•„ìš”í•œ ê²½ìš°, ì•„ë˜ ì„¤ì • ì‚¬ìš©:
    # location /swagger-ui/ {
    #     # ê°œë°œíŒ€ IPë§Œ í—ˆìš© (ì˜ˆì‹œ)
    #     allow 203.0.113.0/24;  # ê°œë°œíŒ€ ë„¤íŠ¸ì›Œí¬
    #     allow 127.0.0.1;       # localhost
    #     deny all;
    #
    #     proxy_pass http://dollar-insight-backend:9090/swagger-ui/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }

    # ============================================
    # ğŸ”’ PROTECTED - Actuator (ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œë§Œ ì ‘ê·¼)
    # ============================================
    location /actuator/ {
        # ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ IPë§Œ í—ˆìš©
        allow 127.0.0.1;       # localhost
        # allow 10.0.0.0/8;    # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ (í•„ìš”ì‹œ ì¶”ê°€)
        deny all;

        proxy_pass http://dollar-insight-backend:9090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============================================
    # ğŸ”’ PROTECTED - Admin Tools (ì™„ì „ ì°¨ë‹¨)
    # ============================================

    # ğŸš« pgAdmin ì°¨ë‹¨
    location /pgadmin/ {
        deny all;
        return 403 "Access Forbidden - Use SSH tunnel for database admin";
        add_header Content-Type text/plain;
    }

    # ğŸš« Mongo Express ì°¨ë‹¨
    location /mongo-express/ {
        deny all;
        return 403 "Access Forbidden - Use SSH tunnel for database admin";
        add_header Content-Type text/plain;
    }

    # ğŸš« Redis Commander ì°¨ë‹¨
    location /redis-commander/ {
        deny all;
        return 403 "Access Forbidden - Use SSH tunnel for database admin";
        add_header Content-Type text/plain;
    }

    # ğŸ’¡ ê´€ë¦¬ ë„êµ¬ê°€ í•„ìš”í•œ ê²½ìš°, SSH í„°ë„ ì‚¬ìš©:
    # ssh -L 5050:localhost:5050 ubuntu@k13b205.p.ssafy.io
    # ê·¸ í›„ ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:5050 ì ‘ê·¼

    # ============================================
    # ğŸ”“ PUBLIC - Backend API (ì•±ì—ì„œ ì‚¬ìš© - JWT ì¸ì¦ í•„ìš”)
    # ============================================

    # SSE ìŠ¤íŠ¸ë¦¼ ì „ìš© (ê¸´ íƒ€ì„ì•„ì›ƒ)
    location ~* ^/api/chat/sessions/[^/]+/stream$ {
        # ë°±ì—”ë“œì—ì„œ JWT í† í° ê²€ì¦
        proxy_pass http://dollar-insight-backend:9090;

        # ê¸°ë³¸ í—¤ë” ì„¤ì •
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Device-Id $http_x_device_id;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_request_headers on;

        # SSE ì „ìš© ì„¤ì •
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;

        # SSE ìŠ¤íŠ¸ë¦¼ìš© ê¸´ íƒ€ì„ì•„ì›ƒ (AI ì‘ë‹µ ìƒì„± ì‹œê°„ ê³ ë ¤)
        proxy_connect_timeout 10s;
        proxy_send_timeout 600s;      # 10ë¶„
        proxy_read_timeout 600s;      # 10ë¶„
    }

    # Backend API í”„ë¡ì‹œ - ì¼ë°˜ API
    location /api {
        # ë°±ì—”ë“œì—ì„œ JWT í† í° ê²€ì¦ (ì¤‘ìš”!)
        # ì¸ì¦ì´ í•„ìš”í•œ ì—”ë“œí¬ì¸íŠ¸ëŠ” ë°±ì—”ë“œì—ì„œ @PreAuthorizeë¡œ ë³´í˜¸
        proxy_pass http://dollar-insight-backend:9090;

        # ê¸°ë³¸ í—¤ë” ì„¤ì •
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Device-Id $http_x_device_id;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_request_headers on;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================
    # ğŸ”“ PUBLIC - AI Service API (ë°±ì—”ë“œë¥¼ í†µí•´ í˜¸ì¶œ)
    # ============================================
    location /ai/ {
        proxy_pass http://dollar-insight-ai-service:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout ì„¤ì • (AI ì²˜ë¦¬ ì‹œê°„ì´ ê¸¸ ìˆ˜ ìˆìŒ)
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ============================================
    # ê¸°ë³¸ ë£¨íŠ¸
    # ============================================
    location / {
        return 200 "Dollar Insight API Gateway - Production Mode\n";
        add_header Content-Type text/plain;
    }
}
