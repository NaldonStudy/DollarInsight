pipeline {
    agent any
    
    environment {
        // Git ì •ë³´
        GIT_CREDENTIAL = 'gitlab-credential'
        
        // Docker Hub ì •ë³´
        DOCKERHUB_USERNAME = 'imtaewon'
        DOCKERHUB_CREDENTIAL = 'dockerhub-credential'
        IMAGE_BASE = "${DOCKERHUB_USERNAME}"
        
        // ë°°í¬ ì„œë²„ ì •ë³´
        DEPLOY_SERVER = 'ubuntu@k13b205.p.ssafy.io'
        DEPLOY_PATH = '/opt/S13P31B205'
        SSH_CREDENTIAL = 'ec2-ssh-key'
        
        PROJECT_NAME = 'dollar-insight'
        
        // ì´ë¯¸ì§€ íƒœê·¸ (Git Commit Hash + Build Number)
        IMAGE_TAG = "${GIT_COMMIT[0..7]}-${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '=== Git Repository Checkout ==='
                checkout scm
                sh 'git log -1 --pretty=format:"%h - %an: %s"'
            }
        }
        
        // ========================================
        // CD: Continuous Deployment (ë¹Œë“œ & ë°°í¬)
        // ========================================
        
        stage('Backend - Build') {
            steps {
                echo '=== Backend Build (Gradle) ==='
                dir('backend') {
                    sh '''
                        chmod +x gradlew
                        ./gradlew build -x test --no-daemon
                        ls -lh build/libs/
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                echo '=== Building Docker Images in Jenkins (Backend, AI Service & Airflow) ==='
                script {
                    // Backend ì´ë¯¸ì§€ ë¹Œë“œ
                    docker.build("${IMAGE_BASE}/dollar-backend:${IMAGE_TAG}", "./backend")
                    docker.build("${IMAGE_BASE}/dollar-backend:latest", "./backend")
                    
                    // AI Service ì´ë¯¸ì§€ ë¹Œë“œ
                    docker.build("${IMAGE_BASE}/dollar-ai:${IMAGE_TAG}", "./ai-service")
                    docker.build("${IMAGE_BASE}/dollar-ai:latest", "./ai-service")
                    
                    // Airflow ì´ë¯¸ì§€ ë¹Œë“œ
                    docker.build("${IMAGE_BASE}/dollar-airflow:${IMAGE_TAG}", "-f ./ai-service/AI_airflow/Dockerfile.airflow ./ai-service/AI_airflow")
                    docker.build("${IMAGE_BASE}/dollar-airflow:latest", "-f ./ai-service/AI_airflow/Dockerfile.airflow ./ai-service/AI_airflow")
                    
                    // Note: Nginx ì´ë¯¸ì§€ëŠ” ë¹Œë“œí•˜ì§€ ì•ŠìŒ (ì„¤ì • ë³€ê²½ ì‹œì—ë§Œ ë³„ë„ ë¹Œë“œ í•„ìš”)
                }
            }
        }
        
        stage('Push to Registry') {
            steps {
                echo '=== Pushing Images to Docker Hub (Backend, AI Service & Airflow) ==='
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKERHUB_CREDENTIAL) {
                        // Backend í‘¸ì‹œ
                        docker.image("${IMAGE_BASE}/dollar-backend:${IMAGE_TAG}").push()
                        docker.image("${IMAGE_BASE}/dollar-backend:latest").push()
                        
                        // AI Service í‘¸ì‹œ
                        docker.image("${IMAGE_BASE}/dollar-ai:${IMAGE_TAG}").push()
                        docker.image("${IMAGE_BASE}/dollar-ai:latest").push()
                        
                        // Airflow í‘¸ì‹œ
                        docker.image("${IMAGE_BASE}/dollar-airflow:${IMAGE_TAG}").push()
                        docker.image("${IMAGE_BASE}/dollar-airflow:latest").push()
                        
                        // Note: Nginx ì´ë¯¸ì§€ëŠ” í‘¸ì‹œí•˜ì§€ ì•ŠìŒ
                    }
                }
            }
        }
        
        stage('Deploy to EC2') {
            steps {
                echo '=== Deploy to Production Server using deploy.sh ==='
                withCredentials([sshUserPrivateKey(credentialsId: SSH_CREDENTIAL, keyFileVariable: 'SSH_KEY')]) {
                    sh """
                        ssh -i \${SSH_KEY} -o StrictHostKeyChecking=no ${DEPLOY_SERVER} '
                            cd ${DEPLOY_PATH}

                            # Git repository ì—…ë°ì´íŠ¸ (í•œ ë²ˆë§Œ ìˆ˜í–‰)
                            echo "=== Updating Git repository ==="
                            git fetch origin
                            git checkout develop
                            git pull origin develop

                            # ë°°í¬í•  ì´ë¯¸ì§€ ë²„ì „ ì„¤ì •
                            export BACKEND_VERSION=${IMAGE_TAG}
                            export AI_VERSION=${IMAGE_TAG}

                            # Airflow ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                            if [ -d "ai-service/AI_airflow" ]; then
                                export AIRFLOW_VERSION=${IMAGE_TAG}
                                echo "=== Airflow detected, will be deployed with version ${IMAGE_TAG} ==="
                            else
                                echo "=== Airflow not found, will deploy Backend & AI Service only ==="
                            fi

                            # deploy.sh ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                            chmod +x deploy.sh

                            # Docker ì„œë¹„ìŠ¤ ë°°í¬
                            echo "=== Running Docker services deployment with version ${IMAGE_TAG} ==="
                            ./deploy.sh deploy

                            # Flutter APK ë¹Œë“œ ë° ë°°í¬ (ë™ì¼í•œ ì½”ë“œ ë²„ì „ ì‚¬ìš©)
                            echo ""
                            echo "=== Building and Deploying Flutter APK ==="
                            ./deploy.sh build-and-deploy-apk

                            # ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
                            echo ""
                            echo "=== ğŸ‰ All Deployments Complete ==="
                            echo "  - Docker Services: backend, ai-service, airflow"
                            echo "  - Flutter APK: https://k13b205.p.ssafy.io/apk/app-release.apk"
                            echo "  - Download Page: https://k13b205.p.ssafy.io/download"
                        '
                    """
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo '=== Verifying Deployment ==='
                withCredentials([sshUserPrivateKey(credentialsId: SSH_CREDENTIAL, keyFileVariable: 'SSH_KEY')]) {
                    sh """
                        ssh -i \${SSH_KEY} -o StrictHostKeyChecking=no ${DEPLOY_SERVER} '
                            cd ${DEPLOY_PATH}
                            
                            # deploy.shì˜ status ëª…ë ¹ìœ¼ë¡œ ë°°í¬ ìƒíƒœ í™•ì¸
                            echo "=== Checking deployment status ==="
                            ./deploy.sh status
                            
                            # Health checkëŠ” deploy.shì—ì„œ ì´ë¯¸ ìˆ˜í–‰ë¨
                            echo ""
                            echo "=== Deployment Verification Complete ==="
                        '
                    """
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                echo '=== Cleanup Old Images ==='
                script {
                    // Jenkins ì„œë²„ì˜ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
                    sh """
                        docker image prune -af --filter "until=24h"
                    """
                }
                
                withCredentials([sshUserPrivateKey(credentialsId: SSH_CREDENTIAL, keyFileVariable: 'SSH_KEY')]) {
                    sh """
                        ssh -i \${SSH_KEY} -o StrictHostKeyChecking=no ${DEPLOY_SERVER} '
                            cd ${DEPLOY_PATH}
                            
                            # deploy.shì˜ cleanup ê¸°ëŠ¥ ì‚¬ìš©
                            ./deploy.sh cleanup
                        '
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '=== âœ… CD Pipeline Success ==='
            echo "Build Number: ${BUILD_NUMBER}"
            echo "Image Tag: ${IMAGE_TAG}"
            echo "Deployed Services: backend, ai-service, airflow"
            echo "Preserved Services: postgres, mongodb, redis, chromadb, nginx, admin tools"
            echo "Deployment completed successfully"
            echo "Deployed at: ${new Date()}"
            echo ""
            echo "=== ğŸ“± Flutter APK Deployment ==="
            echo "APK Download URL: https://k13b205.p.ssafy.io/apk/app-release.apk"
            echo "Download Page: https://k13b205.p.ssafy.io/download"

            withCredentials([sshUserPrivateKey(credentialsId: SSH_CREDENTIAL, keyFileVariable: 'SSH_KEY')]) {
                sh """
                    ssh -i \${SSH_KEY} -o StrictHostKeyChecking=no ${DEPLOY_SERVER} '
                        echo "=== ğŸ“Š Current Service Status ==="
                        cd ${DEPLOY_PATH}
                        docker compose ps
                    '
                """
            }
        }
        
        failure {
            echo '=== âŒ CD Pipeline Failed ==='
            
            // ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ìˆ˜ì§‘
            withCredentials([sshUserPrivateKey(credentialsId: SSH_CREDENTIAL, keyFileVariable: 'SSH_KEY')]) {
                sh """
                    ssh -i \${SSH_KEY} -o StrictHostKeyChecking=no ${DEPLOY_SERVER} '
                        echo "=== ğŸ“‹ Service Logs (Last 50 lines) ==="
                        cd ${DEPLOY_PATH}
                        ./deploy.sh logs || docker compose logs --tail=50
                    ' || true
                """
            }
        }
        
        unstable {
            echo '=== âš ï¸ CD Pipeline Unstable ==='
            echo 'Deployment may be incomplete'
        }
        
        always {
            echo '=== Cleaning up workspace ==='
            cleanWs()
        }
    }
}
